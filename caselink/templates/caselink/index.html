{% load staticfiles %}
<html>
    <head>
        <title>{% block title %} CaseLink {% endblock %} </title>
        <script type="text/javascript" charset="utf8" src="//code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/js-cookie/2.0.4/js.cookie.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.12/js/dataTables.bootstrap.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/select/1.2.0/js/dataTables.select.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.2.2/js/dataTables.buttons.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/1.2.2/js/buttons.bootstrap.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <script src="{% static "caselink/searchtable.js" %}"></script>
        <script src="{% static "caselink/index.js" %}"></script>

        <link rel="stylesheet" href="https://cdn.datatables.net/1.10.12/css/dataTables.bootstrap.min.css"></link>
        <link rel="stylesheet" href="https://cdn.datatables.net/select/1.2.0/css/select.bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.2.2/css/buttons.bootstrap.min.css">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/googlecode.min.css">
        <link rel="stylesheet" href="http://fabien-d.github.io/alertify.js/assets/js/lib/alertify/alertify.core.css" />
        <link rel="stylesheet" href="http://fabien-d.github.io/alertify.js/assets/js/lib/alertify/alertify.default.css" id="toggleCSS" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"></link>
        <link rel="stylesheet" type="text/css" href="{% static "caselink/datatables.css" %}">
        <link rel="stylesheet" type="text/css" href="{% static "caselink/caselink.css" %}">
    </head>
    <body>
        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="{% url 'index' %}">CaseLink</a>
                </div>
                <div id="navbar" class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="#" data-toggle="modal" data-target="#task_panel">Tasks</a></li>
                        <li><a href="{% url 'index' %}">Index</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="modal fade" id="task_panel" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Tasks</h4>
                    </div>
                    <div class="modal-body">
                        <div id="task_progress">
                            <div class="progress progress-bar-proto">
                                <div class="progress-bar progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 45%">
                                </div>
                            </div>
                            <div class="alert alert-success empty-proto" role="alert">There is no running task.</div>
                        </div>
                        <div class="panel panel-default" id="backup_list">
                            <div class="panel-heading">Backup List
                                <form action="control/upload/" method="post" enctype="multipart/form-data" class="hidden" id="backup_upload_form">
                                    {% csrf_token %}
                                    <input type="file" name='file' id="backup_upload_input">
                                </form>
                                <a href="javascript:void(0)"><i class="fa fa-upload pull-right backup-upload" aria-hidden="true">&nbspUpload&nbsp</i></a>
                                <a href="javascript:void(0)"><i class="fa fa-plus pull-right backup-new" aria-hidden="true">&nbspNew&nbsp</i></a>
                            </div>
                            <ul class="list-group">
                                <li class="list-group-item empty-item">No Backup</li>
                                <li class="list-group-item backup-item">
                                    <a href="javascript:void(0)"><i class="fa fa-download pull-right backup-download" aria-hidden="true">&nbspDownload&nbsp</i></a>
                                    <a href="javascript:void(0)"><i class="fa fa-medkit pull-right backup-restore" aria-hidden="true">&nbspRestore&nbsp</i></a>
                                    <a href="javascript:void(0)"><i class="fa fa-trash pull-right backup-delete" aria-hidden="true">&nbspDelete&nbsp</i></a>
                                </li>
                            </ul>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger btn-cancel">Cancel All Tasks<i class="fa fa-fw fa-close" aria-hidden="true"></i></button>
                        <button type="button" class="btn btn-info btn-op btn-auto-error">Autocase Error Check<i class="fa fa-fw fa-cog" aria-hidden="true"></i></button>
                        <button type="button" class="btn btn-info btn-op btn-manual-error">Manualcase Error Check<i class="fa fa-fw fa-cog" aria-hidden="true"></i></button>
                        <button type="button" class="btn btn-info btn-op btn-linkage-error">Linkage Error Check<i class="fa fa-fw fa-cog" aria-hidden="true"></i></button>
                    </div>
                </div><!-- /.modal-content -->
            </div>
        </div>

        <div class="container-fluid">
            {% block content %}
            <div class="container">
                <div class="panel panel-default">
                    <div class="panel-heading">Table</div>
                    <div class="panel-body">
                        <a type="button" class="btn btn-info" href="a2m">Auto to Manual case linkage</a>
                        <a type="button" class="btn btn-info" href="m2a">Manual to Auto case linkage</a>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">API</div>
                    <div class="panel-body">
                        <a type="button" class="btn btn-default" href="manual">Manual Case API</a>
                        <a type="button" class="btn btn-default" href="auto">Auto case API</a>
                        <a type="button" class="btn btn-default" href="link">Linkage API</a>
                    </div>
                </div>
            </div>
            {% endblock %}
        </div>
        <script src="http://fabien-d.github.io/alertify.js/assets/js/lib/alertify/alertify.min.js"></script>
        <script>
            var polling = false;
            $(document).ready(function() {
                var task_progress = $("#task_progress");
                var progress_bar = $("#task_progress .progress-bar-proto").detach();
                var empty_task = $("#task_progress .empty-proto");

                var backup_list = $("#backup_list ul.list-group");
                var backup_item = $("#backup_list li.backup-item").detach();
                var empty_backup = $("#backup_list li.empty-item");

                $('#task_panel').on('hidden.bs.modal', function (e) {
                    polling = false;
                })

                $('#task_panel').on('show.bs.modal', function (e) {
                    polling = true;
                    poll_status();
                })

                function gen_progress_bar(cur, total, text){
                    bar = progress_bar.clone();
                    progress = bar.find(".progress-bar");
                    percent = (cur/total) * 100.0;

                    if(text){
                        progress.text(text);
                    }
                    else{
                        progress.text("" + cur + "/" + total + "");
                    }
                    progress
                    .attr("aria-valuenow", cur)
                    .attr("aria-valuemax", total)
                    .attr("aria-valuemin", 0)
                    .css("min-width", "6em")
                    .css("width", "" + percent + "%");

                    return bar
                }

                function ajax_with_alert(url){
                    $.ajax({
                        'url':url,
                        'cache': false
                    }).done(function(data){
                        alert(JSON.stringify(data));
                    });
                }

                $(".btn-cancel").click(function(){ ajax_with_alert('control/trigger/?cancel=true'); });
                $(".btn-auto-error").click(function(){ ajax_with_alert('control/trigger/?async=true&trigger=autocase_error_check'); });
                $(".btn-manual-error").click(function(){ ajax_with_alert('control/trigger/?async=true&trigger=manualcase_error_check'); });
                $(".btn-linkage-error").click(function(){ ajax_with_alert('control/trigger/?async=true&trigger=linkage_error_check'); });
                $(".backup-new").click(function(){ ajax_with_alert('control/trigger/?async=true&trigger=dump_all_db'); });
                $(".backup-upload").click(function(){
                    $('#backup_upload_input').click();
                });
                $('#backup_upload_input').change(function() {
                    console.log("changed")
                    $('#backup_upload_form').submit();
                });
                $("#backup_list .list-group").on('click', '.backup-download', function(){
                    yaml = $(this).closest('li').clone().children().remove().end().text().trim();
                    top.location.href = 'control/backup/' + yaml;
                    console.log( 'control/backup/' + yaml);
                });
                $("#backup_list .list-group").on('click', '.backup-restore', function(){
                    yaml = $(this).closest('li').clone().children().remove().end().text().trim();
                    ajax_with_alert('control/restore/'+ yaml);
                });
                $("#backup_list .list-group").on('click', '.backup-delete', function(){
                    yaml = $(this).closest('li').clone().children().remove().end().text().trim();
                    ajax_with_alert('control/backup/'+ yaml + '?delete=true');
                });

                function poll_status(){
                    $.ajax({
                        'url':'control/',
                        'cache': false
                    })
                    .done(function(data){
                        task_progress.empty()
                        if($.isEmptyObject(data.task)) {
                            task_progress.append(empty_task);
                        }
                        else{
                            for(i in data.task){
                                console.log(data.task)
                                console.log(data.task[i])
                                task_progress.append("<h3>"+i+"</h3>");
                                if(data.task[i].meta){
                                    cur = data.task[i].meta.current;
                                    total = data.task[i].meta.total;
                                    task_progress.append(gen_progress_bar(cur,total));
                                }
                                else{
                                    task_progress.append(gen_progress_bar(1, 1, data.task[i].state || "STATE NOT AVALIABLE"));
                                }
                            }
                        }

                        backup_list.empty()
                        if($.isEmptyObject(data.backup)) {
                            backup_list.append(empty_backup);
                        }
                        else{
                            for(var i = 0, len = data.backup.length; i < len; i++){
                                item = backup_item.clone()
                                item.prepend("<span class=\"label label-default\">"+ (parseInt(data.backup[i].size)/(1024*1024)).toFixed(1) +"MB</span>");
                                item.prepend(data.backup[i].file);
                                backup_list.append(item);
                            }
                        }
                    });
                    if(polling)
                        setTimeout(poll_status, 1000);
                }
            });
        </script>
    </body>
</html>
