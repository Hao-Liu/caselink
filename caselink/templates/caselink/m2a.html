{% extends "caselink/index.html" %}
{% block title %} Libvirt Manual-Auto Case Linkage {% endblock %}
{% block content %}

<div class="panel panel-default">
    <!-- Default panel contents -->
    <div class=""> <h3 align='center'>Manual to Auto Linkage Table</h3> </div>
    <!-- Table -->
    <table id="sortable-table" class="table table-striped table-hover">
        <thead>
            <th>Polarion</th>
            <th>Title</th>
            <th>Documents</th>
            <th>Automation</th>
            <th>Errors</th>
            <th>Cases</th>
            <th>Patterns</th>
        </thead>
        <tfoot>
            <th>Polarion</th>
            <th>Title</th>
            <th>Documents</th>
            <th>Automation</th>
            <th>Errors</th>
            <th>Cases</th>
            <th>Patterns</th>
        </tfoot>
    </table>
</div>

<div id="_proto_detail_panel" class="hidden">
    <table class="table table-hover table-condensed">
        <tbody>
            <tr>
                <td> Autotest Cases: </td>
                <td class="detail-autocase"></td>
            </tr>
            <tr>
                <td> Errors: </td>
                <td class="detail-error"></td>
            </tr>
            <tr>
                <td> Patterns: </td>
                <td class="detail-pattern"></td>
            </tr>
        </tbody>
    </table>
</div>

</div>
<script type="text/javascript">
    $(document).ready(function() {
        var child_detail = $('#_proto_detail_panel').removeClass('hidden').detach();
        var table = $('#sortable-table').DataSearchTable({
            BaseTable: [DataTableWithChildRow,],
            "ajax": "data",
            "iDisplayLength": 20,
            "bAutoWidth": false,
            "selectorColumns": [
                {
                    column: 'Documents',
                    render: prettier,
                },
                {
                    column: 'Automation',
                    render: prettier,
                    strict: true,
                },
                {
                    column: 'Errors',
                    render: prettier,
                },
            ],
            "columns": [
                {
                    "data": "polarion",
                    "render": function( data ) {
                        return '<a href="https://polarion.engineering.redhat.com/polarion/#/project/RedHatEnterpriseLinux7/workitem?id='+data+'">'+data+'</a>';
                    }
                },
                { "data": "title" },
                {
                    "data": "documents",
                    "render": function( data ) {
                        return prettier(data.join('<br>'));
                    }
                },
                { "data": "automation" },
                {
                    "data": "errors",
                    "render": function( data ) {
                        return prettier(data.join('<br>'));
                    }
                },
                {
                    "data": "cases",
                    "visible": false,
                    "render": prettier,
                },
                {
                    "data": "patterns",
                    "visible": false,
                    "render": prettier,
                },
            ],
            "createdRow": function(row, data, index){
                if(data.errors.length > 0){
                    $('td', row).eq(0).addClass('errors');
                }
            },

            // Add event listener for opening and closing details
            childContent: function(row, child, slideDown, slideUp){
                var head = child_detail.clone()
                var d = row.data();

                if(d.cases.length > 0){
                    head.find(".detail-autocase").html(d.cases.join("<br>"))
                }
                else{
                    head.find(".detail-autocase").closest("tr").remove()
                }

                if(d.errors.length > 0){
                    head.find(".detail-error").html(d.errors.join("<br>"))
                }
                else{
                    head.find(".detail-error").closest("tr").remove()
                }

                if(d.patterns.length > 0){
                    console.log(d.patterns.join("<br>"))
                    head.find(".detail-pattern").html(d.patterns.join("<br>"))
                }
                else{
                    head.find(".detail-pattern").closest("tr").remove()
                }

                if (d.patterns.length + d.errors.length + d.cases.length === 0) {
                    head.empty().append('<div class="alert alert-info" role="alert">Nothing to show.</div>');
                    setTimeout(slideUp, 800);
                }

                child.append(head.html());
                slideDown();
            },
        });
    });
</script>
<a href='control?trigger=manualcase_error_check&trigger=linkage_error_check' target='_blank'>Check Manual case and Linkage errors.</a>
{% endblock %}
